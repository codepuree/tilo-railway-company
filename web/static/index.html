<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <script src="/static/js/control-component.js"></script>
    <script src="/static/js/map-component.js"></script>
    <script src="/static/js/console-component.js"></script>
    <link href="http://fonts.cdnfonts.com/css/myriad-pro" rel="stylesheet" />
    <style>
    :root {
        --clr-gap: #191919;
        --clr-bg: #222223;
        --clr-inactive: #3c3c3c;
        --clr-active: #e5e5e4;
        --gap: 8px;
    }

    *, *::before, *::after {
        box-sizing: border-box;
        font-family: 'Myriad Pro', san-serif;
        font-weight: 600;
        text-transform: uppercase;
        text-align: center;
        /* font-size: 5vh; */
        color: white;
        letter-spacing: 0.5vh;
    }

    html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        max-height: 100%;
        overflow: hidden;
        background: var(--clr-gap);
    }

    body {
        margin: 0;
        display: grid;
        grid-template:
            "header header logo" 15vh
            "left main right" 1fr
            / 20vw 1fr 20vw;
        gap: var(--gap);
        padding: var(--gap);
        height: 100%;
        overflow: hidden;
        background: var(--clr-gap);
    }

    body>* {
        background-color: var(--clr-bg);
        overflow: hidden;
    }

    main {
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    main>* {
        flex: 1 auto;
        overflow: hidden;
        padding: var(--gap);
    }

    main>article>object {
        height: 100%;
        max-width: 100%;
    }
    </style>
    <style>
    input[type=text] {
        font-size: 23px;
        width: 60px;
        background-color: var(--clr-inactive);
        color: var(--clr-active);
        border: 1px solid var(--clr-active);
        padding: 2px;
        margin: 0;
    }
    </style>
</head>

<body>
    <header style="grid-area: header; padding: var(--gap);">
        <object id="header" type="image/svg+xml" data="/static/svg/SplitFlap_Mockup.svg" style="height: 100%; width: 100%; max-height: 100%; max-width: 100%;">
            Logo
        </object>
    </header>
    <div style="grid-area: logo; padding: calc(var(--gap) + 3px);" onclick="console.log('test');document.fullscreen ? document.exitFullscreen() : document.documentElement.requestFullscreen()">
        <object id="logo" type="image/svg+xml" data="/static/svg/Logo_light.svg" style="height: 100%; width: 100%; max-height: 100%; max-width: 100%;">
            Logo
        </object>
    </div>
    <aside style="grid-area: left">
        <div class="icons">
            <label class="switch"><input type="checkbox"><span class="slider round"></span></label>
            <input type="text" />
            <label class="switch"><input type="checkbox"><span class="slider round"></span></label>
            <input hidden type="checkbox" id="tog-console">
            <label for="tog-console">üñ•Ô∏è</label>
            <label for="tog-console">Console</label>
        </div>
        <div class="labels">
            <label>Option 1</label>
            <label>Option 2</label>
            <label>Option 3</label>
        </div>
    </aside>
    <main style="grid-area: main">
        <!-- Upper level -->
        <trc-map id="upperMap" src="/static/svg/strecke_oben.svg"></trc-map>
        <trc-map id="lowerMap" src="/static/svg/strecke_unten.svg"></trc-map>
    </main>
    <aside style="grid-area: right; padding: var(--gap);">
        <trc-control value="42" actual-speed="10"></trc-control>
    </aside>
    <trc-console id="dev-console"></trc-console>
    <!-- <dialog id="dev-console" -->
    <!--     style="/*display: grid;*/ grid-auto-rows: auto 1fr auto; padding: 4vmin; grid-gap: 4vmin; height: 50vh; margin: 25vh auto;"> -->
    <!--     <header> -->
    <!--         <h3 style="grid-column: span 3; margin: 0; padding: 0;">Serial command line:</h3> -->
    <!--         <button -->
    <!--             onclick="confirm('M√∂chtest du wirklich herunterfahren?') ? fetch('/sys/shutdown') : void(0)">üõë</button> -->
    <!--         <button onclick="confirm('M√∂chtest du wirklich neustarten?') ? fetch('/sys/reboot') : void(0)">üîÑ</button> -->
    <!--     </header> -->
    <!--     <main style="overflow: hidden;"> -->
    <!--         <div id="outMsg" style="grid-column: span 3; overflow: auto;"></div> -->
    <!--     </main> -->
    <!--     <footer> -->
    <!--         <label for="inMsg">Message:</label><input id="inMsg" type="text" style="width: 100%;"> -->
    <!--         <input id="btnSend" type="button" value="Send"> -->
    <!--     </footer> -->
         <script> 
             const togConsole = document.querySelector("#tog-console") 
             const devConsole = document.querySelector('trc-console') 
             togConsole.addEventListener("change", event => { 
                 devConsole.open = event.target.checked 

                 if (event.target.checked) { 
                     devConsole.style.display = "grid" 
                 } else { 
                     devConsole.style.display = "none" 
                 } 
             }) 
         </script> 
    <!-- </dialog> -->
    <script src="/static/js/signal-tower.js"></script>
    <script>
        const signalTower = new SignalTower();
        const lowerMap = document.querySelector('#lowerMap')

        const red = '#e44513'
        const yellow = '#eac721'
        const green = '#46ae3c'
        const gray = '#a8a8a8'
        const white = '#ffffff'
        const transparent = 'rgba(255, 255, 255, 0.0)'
        const blue = '#0fb5e8'
        const black = 'black'

        // const printMessage = document.querySelector('trc-console').printMessage
        const outMsg = document.querySelector('#outMsg') | document.querySelector('trc-console') 
        function printMessage(msg, type_ = 'log') { 
            document.querySelector('trc-console').printMessage(msg, type_)
            /*let out = '' 
            switch (type) { 
                case 'error': 
                    out = `<span style="color: red;"><b>Error:</b> ${msg}</span><br>` 
                    break; 

                case 'warning': 
                    out = `<span style="color: orange;"><b>Warning:</b> ${msg}</span><br>` 
                    break; 

                case 'info': 
                    out = `<span style="color: darkgray;"><b>Info:</b> ${msg}</span><br>` 
                    break; 

                case 'log': 
                default: 
                    out = `<span>${msg}</span><br>` 
                    break; 
            } 

            outMsg.innerHTML = outMsg.innerHTML + out 
            console.log('lastChild', outMsg.lastChild) 
            outMsg.lastChild.scrollIntoView() */
        } 

        const webSocket = startWebsocket()

        function startWebsocket() {
            let webSocket = new WebSocket(`ws://${location.host}/websocket`)

            webSocket.onopen = open => {
                console.log('Open:', open)
                printMessage("Successfully connected to Raspberry PI")
            }

            webSocket.onmessage = message => {
                const msg = JSON.parse(message.data)

                console.log('Message:', msg)
                printMessage(msg.data)

                // Map test
                renderMap(lowerMap, msg)

                if (msg.from === "arduino") {
                    signalTower.receiveMessage(msg.data)
                }

            }

            webSocket.onerror = error => {
                console.log('Error:', error)
                printMessage(error, 'error')
            }

            webSocket.onclose = close => {
                console.log('Close:', close)
                printMessage("Receonnecting in 5sec...", 'info')
                setTimeout(_ => {
                    webSocket = startWebsocket()
                }, 5000)
            }

            return webSocket
        }

        /* document.querySelector('#btnSend').addEventListener('click', event => {
            webSocket.send(document.querySelector('#inMsg').value)
        }) */

        function addScriptButton(name, func) {
            let li = document.createElement('li')
            let btn = document.createElement('button')
            btn.innerText = name
            btn.onclick = func
            li.appendChild(btn)
            document.querySelector('#more>ul').appendChild(li)
        }

        function renderMap(map, msg) {
            map = document.querySelector('#lowerMap')
            if (msg.from == "traincontrol") {
                //Direction
                if (msg.data.direction != undefined) {
                    if (msg.data.direction == "f") {
                        map.direction = 'w'
                    }
                    else /*(msg.data.direction == "b")*/ {
                        map.direction = 'e'
                    }
                }

                //Speed
                if (msg.data.velocity != undefined) {
                    map.speed = msg.data.velocity
                }
            }
            else if (msg.from == "arduino") {
                msg = msg.data
                if (Number.isInteger(parseInt(msg.charAt(0)))) {
                    // Sensor
                    let id = msg.substring(0, 2)
                    let state = msg.charAt(2)

                    const sns = map.querySelector(`#sns${id}`)

                    function visGl(id, state) {
                        const gl = map.querySelector(`#gl${id}`) //o,w,m (ost , west , middle)
                        if (gl.style.fill != blue) {
                            if (state == "l") { // Low
                                gl.style.fill = black
                            } else { // High
                                gl.style.fill = transparent
                            }
                        }
                    }

                    switch (id) {
                        case "12": //Track4_out
                            setTimeout(_ => {
                                visGl("do", 'h')
                                visGl("dm", 'h')
                                visGl("dw", 'h')
                            }, 0)
                            break;

                        case "16": //Track4_in
                            visGl("do", 'l')
                            visGl("dm", 'l')
                            visGl("dw", 'l')
                            break;

                        case "11": //Track3_out
                            setTimeout(_ => {
                                visGl("co", 'h')
                                visGl("cm", 'h')
                                visGl("cw", 'h')
                            }, 0)
                            break;

                        case "15": //Track3_in
                            visGl("co", 'l')
                            visGl("cm", 'l')
                            visGl("cw", 'l')
                            break;

                        case "10": //Track2_out
                            setTimeout(_ => {
                                visGl("bo", 'h')
                                visGl("bm", 'h')
                                visGl("bw", 'h')
                            }, 0)
                            break;

                        case "14": //Track2_in
                            visGl("bo", 'l')
                            visGl("bm", 'l')
                            visGl("bw", 'l')
                            break;

                        case "09": //Track1_out
                            setTimeout(_ => {
                                visGl("ao", 'h')
                                visGl("am", 'h')
                                visGl("aw", 'h')
                            }, 0)
                            break;

                        case "13": //Track1_in
                            visGl("ao", 'l')
                            visGl("am", 'l')
                            visGl("aw", 'l')
                            break;

                        default:
                            if (state == "l") { // Low
                                sns.style.fill = yellow
                            } else { // High
                                sns.style.fill = white
                            }
                    }

                } else if (msg.charAt(0) == "y") {
                    // Weiche
                    let id = msg.charAt(1)
                    let state = msg.charAt(2)
                } else {
                    // Block
                    let id = msg.charAt(0)

                    const gl = map.querySelector(`gl${id}`)

                    if (msg.charAt(1) == "d") {
                        let direction = msg.charAt(2)

                    } else {
                        let speed = parseInt(msg.substring(2, 4))

                        if (speed > 0) {

                        } else {

                        }
                    }
                }
            }
        }

        function addInteractivity(map) {
            // direction selection
            map.querySelector('#diro_active').style.display = "none" //start case
            map.querySelector('#dirw_active').style.display = "none"
            map.querySelector('#diro').addEventListener('click', event => {
                webSocket.send("s:SetDirection(\"b\")")
            })

            map.querySelector('#dirw').addEventListener('click', event => {
                webSocket.send("s:SetDirection(\"f\")")
            })

            map.querySelector('#sig1o').addEventListener('click', event => {
                webSocket.send("s:SetTrack(\"ao\")")
            })

            map.querySelector('#sig1w').addEventListener('click', event => {
                webSocket.send("s:SetTrack(\"aw\")")
            })

            map.querySelector('#sig2o').addEventListener('click', event => {
                webSocket.send("s:SetTrack(\"bo\")")
            })

            map.querySelector('#sig2w').addEventListener('click', event => {
                webSocket.send("s:SetTrack(\"bw\")")
            })

            map.querySelector('#sig3o').addEventListener('click', event => {
                webSocket.send("s:SetTrack(\"co\")")
            })

            map.querySelector('#sig3w').addEventListener('click', event => {
                webSocket.send("s:SetTrack(\"cw\")")
            })

            map.querySelector('#sig4o').addEventListener('click', event => {
                webSocket.send("s:SetTrack(\"do\")")
            })

            map.querySelector('#sig4w').addEventListener('click', event => {
                webSocket.send("s:SetTrack(\"dw\")")
            })

        }

       document.querySelector('#lowerMap').addEventListener('readystatechange', _ => {
            addInteractivity(document.querySelector('#lowerMap').contentDocument)
        })

        document.querySelector('trc-control').addEventListener('speed', event => console.log(event.detail))
        document.querySelector('trc-control').addEventListener('emergencystop', event => webSocket.send("s:EmergencyStop2Arduino"))
    </script>
</body>
</html>
